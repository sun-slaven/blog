---
title: OSI模型、网络架构
tags:
  - OSI模型
categories:
  - 计算机网络
date: 2017-02-19 15:06:39
---
![](http://7xs8pt.com1.z0.glb.clouddn.com/OSI_1.png)
![](http://7xs8pt.com1.z0.glb.clouddn.com/OSI_2.png)
### 1.实体层（0/1）
使用光缆、电缆、双绞线、无线电波等方式将电脑连接起来组网，作用是负责传送0和1的信号

### 2. 数据链路层（帧，mac地址、CSMA/CD）
为了识别0和1的含义，需要规定一个解读方式，即多少个信号算一组，每位又有什么含义。链路层的作用就是规定了这个解读方式的含义。
![](http://7xs8pt.com1.z0.glb.clouddn.com/OSI_2.1.png)
后来，所有的绝对方式中，以太网（Ethernet）的协议占据主导地位，它规定：

一组电信号构成一个"帧"（Frame），每一帧分成两个部分：标头（Head）和数据（Data）。（注：其实还有帧尾，作为结束标志）

head长度固定是18字节，data的长度最短为46字节，所以一帧最短为64字节，最多1518字节，超过则需要分割成多个帧发送。data大小受MTU（最大传输单元）控制。

head包含了发送者和接受者的信息，如何标定谁是发送者和接受者呢？于是规定了mac地址。

以太网规定，入网必须具有网卡接口，mac地址就是发送者网卡地址和接受者网卡地址。长度是48个二进制位，通常用12个十六进制数表示。也就是说，必须知道下一步的接收方的mac地址才能发送数据包。那么如何知道接收方的mac地址？通过ARP协议。ARP协议可以知晓子网内所有机器的mac地址。

有了mac地址，又如何把数据准确的送到接收方？以太网并没有直接解决这个问题，而是很“原始”的采用广播方式（Broadcast）：向本网络内所有计算机发送，让每台计算机自己判断，是否为接收方。局域网内其他机器收到包后找到head中的目标mac地址与自身比对，发现不是时则丢弃。

以太网是载波侦听（CSMA/CD）。通俗一点讲就是“一个人在点到，大家都在听，点到自己才回答，没有点自己别吭声”。它是一种广播链路，共享信道方式。
![](http://7xs8pt.com1.z0.glb.clouddn.com/OSI_2.2.png)

数据链路层还有一种共享信道方式： P2P，即点对点式。使用P2P的主机既是client，又是Server。很多的多媒体服务都是通过这种方式实现文件下载。
### 3.网络层（IP、ARP、ICMP）
1. #### 由来
    理论上，依靠以太网协议规定的mac地址就可以全球定位唯一一个接受方，但是若以广播的方式去传输数据则是一个灾难。

    ![](http://7xs8pt.com1.z0.glb.clouddn.com/OSI_3.1.png)

    互联网是无数子网络共同组成的一个巨型网络。如果是同一个子网络，就采用广播方式发送，否则就采用"路由"方式发送。如何判定哪些mac地址是属于同一个网络？以太网协议无法做到这一点。于是诞生了网络层。
2. #### 网络层
    网络层的作用是引进一套新的地址，区分不同的计算机是不是属于同一个子网。

    规定网络地址的协议，叫IP协议：IPv4规定由32个二进制位组成。习惯上，我们用分成四段的十进制数表示IP地址，从0.0.0.0一直到255.255.255.255

    IP地址由网络地址+主机地址组成，单单从IP地址是无法判断两个IP是不是处于同一个子网的。这就需要“子网掩码”的帮忙，子网掩码都是机器自身设置。

    所谓"子网掩码"，就是表示子网络特征的一个参数。它在形式上等同于IP地址，也是一个32位二进制数字，它的网络部分全部为1，主机部分全部为0。比如，IP地址172.16.254.1，如果已知网络部分是前24位，主机部分是后8位，那么子网络掩码就是11111111.11111111.11111111.00000000，写成十进制就是255.255.255.0。知道"子网掩码"，我们就能判断，任意两个IP地址是否处在同一个子网络。方法是将两个IP地址与子网掩码分别进行AND运算（两个数位都为1，运算结果为1，否则为0），然后比较结果是否相同，如果是的话，就表明它们在同一个子网络中，否则就不是。比如，已知IP地址172.16.254.1和172.16.254.233的子网掩码都是255.255.255.0，请问它们是否在同一个子网络？两者与子网掩码分别进行AND运算，结果都是172.16.254.0，因此它们在同一个子网络。

    IP协议的作用主要有两个：一个是为每一台计算机分配IP地址，另一个是确定哪些地址在同一个子网络。

    **IP数据包** 以太网数据包只包含mac地址，并没有IP地址的栏位，那么是否需要修改数据定义，再添加一个栏位呢？自然不需要。我们可以把IP数据包直接放进以太网数据包的Data部分（注：为什么不是反过来用IP数据包包含帧数据？因为根据分层结构，上层的数据需要由下层内容来传输。因此，网络层的数据包是包含在帧里的），这就是互联网分层结构的好处：上层的变动完全不涉及下层的结构。

    封装了IP数据包的以太网包（红色为IP数据包）：

    ![](http://7xs8pt.com1.z0.glb.clouddn.com/OSI_3.2.png)

    IP数据包的"标头"部分的长度为20到60字节，整个数据包的总长度最大为65,535字节。因此，理论上，一个IP数据包的"数据"部分，最长为65,515字节。因为以太网数据包的"数据"部分最长只有1500字节。因此，如果IP数据包超过了1500字节，它就需要分割成几个以太网数据包，分开发送。（注：一个IP数据包不是与一个以太网数据包一一对应，是1对n的关系，一个晚完整的IP包可能需要多个帧来完成承载）。

### 4.传输层（端口、TCP、UDP）
 1. #### 由来
    有了mac地址和IP地址，两台任意地方的电脑已经可以建立通信了。问题是，一个电脑上有很多程序都需要网络访问来获得数据，但是一个数据包接收到的时候，怎么知道这个数据是哪个应用需要的？所以，我们还需要有一个参数，完成这个功能。这就是端口（port），它其实是每一个使用网卡的程序的编号。每个数据包都发到主机的特定端口，所以不同的程序就能取到自己所需要的数据。"端口"是0到65535之间的一个整数，正好16个二进制位。0到1023的端口被系统占用，用户只能选用大于1023的端口。

    "传输层"的功能，就是建立"端口到端口"的通信。相比之下，"网络层"的功能是建立"主机到主机"的通信。只要确定主机和端口，我们就能实现程序之间的交流。因此，Unix系统就把主机+端口，叫做"套接字"（socket）。有了它，就可以进行网络应用程序开发了。

 2. #### UDP协议
    UDP数据包，也是由"标头"和"数据"两部分组成。标头"部分主要定义了发出端口和接收端口（蓝色为UDP数据包）。

    ![](http://7xs8pt.com1.z0.glb.clouddn.com/OSI_4.2.png)

    UDP数据包非常简单，"标头"部分一共只有8个字节，总长度不超过65,535字节，正好放进一个IP数据包。

    UDP协议的优点是比较简单，容易实现，但是缺点是可靠性较差，一旦数据包发出，无法知道对方是否收到。
 3. #### TCP协议
    TCP是为了解决UDP传输不可靠的问题而产生。TCP协议能够确保数据不会遗失。它的缺点是过程复杂、实现困难、消耗较多的资源。

    TCP通过校验和、序列号、确认应答、重发控制、连接管理以及窗口控制等机制实现可靠性传输。

    数据通信之前必须先做好连接工作，在TCP中连接的建立需要三次握手，同时在通信结束时会进行断开连接的处理（四次挥手）。一个连接的建立与断开，正常过程至少需要来回送7个包才能完成。

    ![](http://7xs8pt.com1.z0.glb.clouddn.com/OSI_4.3.1.png)

    在TCP中，当发送端的数据到达主机时，接收端主机会返回一个已收到消息的通知，这个消息叫ACK（确认应答，Positive Acknowledgement）。如果没有收到ACK，那么很可能出现了丢包或者返回的确认在途中丢失，此外，也可能是由于其他原因，ACK延迟到达。发送方没有收到ACK的话就会进行重发，但是针对延迟和ACK丢失的情况，会存在重复发送和接收。于是我们就引入了一种机制，来识别是否已经接收数据，又能识别是否已经接收。

    上述重复控制的功能可以通过序列号来实现。序列号是按照顺序给发送数据的每一个字节都标上号码的编号，接收端查询接收数据TCP首部中的序列号和数据的长度，将自己下一步应该接收的序号作为确认应答号返送回去。通过序列号和确认应答号，TCP实现可靠传输。

    ![](http://7xs8pt.com1.z0.glb.clouddn.com/OSI_4.3.2.png)

    ![](http://7xs8pt.com1.z0.glb.clouddn.com/OSI_4.3.3.png)

    TCP数据包没有长度限制，理论上可以无限长，但是为了保证网络的效率，通常TCP数据包的长度不会超过IP数据包的长度，以确保单个TCP数据包不必再分割。

### 5. 应用层（HTTP、FTP、SMTP、DHCP）
由于互联网是开放架构，数据来源五花八门，必须事先规定好格式，否则根本无法解读。

"应用层"的作用，就是规定应用程序的数据格式。
举例来说，TCP协议可以为各种各样的程序传递数据，比如Email、WWW、FTP等等。那么，必须有不同协议规定电子邮件、网页、FTP数据的格式，这些应用程序协议就构成了"应用层"。

它的数据就放在TCP数据包的"数据"部分。因此，现在的以太网的数据包就变成下面这样。

![](http://7xs8pt.com1.z0.glb.clouddn.com/OSI_5.png)

### 6. 分包举例
假设一个HTTP协议的长度是4960字节，它会被嵌入TCP数据包中。

TCP数据包的标头长度为20字节，加上嵌入HTTP的数据包，总长度变为4980字节。

然后，TCP数据包再嵌入IP数据包。IP数据包的标头长度为20字节，加上嵌入的TCP数据包，总长度变为5000字节。

以太网数据包的数据部分，最大长度为1500字节，而现在的IP数据包长度为5000字节。因此，IP数据包必须分割成四个包。因为每个包都有自己的IP标头（20字节），所以四个包的IP数据包的长度分别为1500、1500、1500、560。

在IP数据包包装TCP协议、TCP协议包装HTTP协议包的过程中，正常是不会发生分包的。而到链路层数据包一般都需要分包包装IP数据包。

### 7.帧、数据报、数据包的区别

    二层的PDU叫做Frame;
    IP的叫做Packet;
    TCP的叫做Segment；
    UDP的叫做Datagram。

在发出数据包时，层层下发包装（从内到外由高级到低级），到网卡输出为0，1电频信号在电缆里传输，接收方按多少电频一组读取成为帧，然后再上发剥离出对应层级的数据包。

---         
参考以下资源：
1. http://www.cnblogs.com/fengmin/p/5318874.html    

2. http://www.ruanyifeng.com/blog/2012/05/internet_protocol_suite_part_i.html

3. http://m.blog.csdn.net/article/details?id=51295965     
